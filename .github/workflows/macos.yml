---
name: macOS

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/macos.yml
  schedule:
    - cron: 45 23 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:

    strategy:
      fail-fast: false
      matrix:
        image: [macos-13, macos-12, macos-11]
    runs-on: ${{ matrix.image }}
    name: ${{ matrix.image }}
    steps:
      - name: Install chezmoi
        run: |
          brew install chezmoi

      # Homebrew has dropped support for macos-11, pin to the last support commit
      - name: Recover homebrew support on macos-11
        if: matrix.image == 'macos-11'
        run: |
          rm -rf "$(brew --repository)/Library/Taps/homebrew/homebrew-core"
          mkdir -p "$(brew --repository)/Library/Taps/homebrew/homebrew-core"
          cd "$(brew --repository)/Library/Taps/homebrew/homebrew-core"
          git init
          git remote add origin https://github.com/Homebrew/homebrew-core.git
          git fetch --depth 1 origin db654ea95a8289f0c0f22a68ccf87e28be7f4261
          git checkout FETCH_HEAD

      # BUG: on macos, some files are owned by root
      # This may cause chezmoi to fail to apply
      - name: Fix permission issue
        run: |
          sudo chown -R $USER $HOME
          ls -la $HOME

      - name: Test dotfile on ${{ matrix.image }}
        env:
          HUGGINGFACE_BUILDING: "true"
          DEBIAN_FRONTEND: noninteractive
          HOMEBREW_NO_INSTALL_FROM_API: 1
        run: |
          chezmoi init "${{ secrets.DOTFILES_REPO }}" --depth 1 --no-pager --no-tty --keep-going
          chezmoi apply --init --force --no-pager --no-tty --keep-going
      - name: Integrity check on ${{ matrix.image }}
        run: |
          $HOME/.local/bin/custom/chezmoi-integrity
